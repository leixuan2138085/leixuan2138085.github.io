---
title: 一个简约扁平化的Hexo静态主题博客-Quiet
comments: false
categories: 项目案例
aubot: Cange-Q
aubot_link: 'https://github.com/79E/hexo-theme-quiet'
tags:
- Hexo
- Quiet
- 主题
- 静态主题
excerpt: 采用简约大方的扁平化Hexo-Quiet主题
toc: false
date: 2020-11-03 20:33:36
cover: 'https://cdn.jsdelivr.net/gh/duogongneng/MyBlogImg/imgQuietView.png'# 二维码追溯系统（QRS）整体逻辑梳理
---
## 一、系统概述

这是一个**农药二维码追溯管理系统（QRS - QR Traceability System）**，专门用于农药产品的全生命周期追溯管理。系统严格按照国家农药追溯管理要求，实现了从产品备案、生码、生产、包装、入库、出库到消费者追溯的全流程管理。


---

## 二、核心业务流程

### 2.1 主流程（QR追溯作业主流程）

```
【线下准备阶段】
1. 开发新产品
2. 监管平台产品备案 + 申请码段
   - 产品备案（中国农药信息网）：
     * 登录平台：http://www.chinapesticide.org.cn（农业农村部农药检定所）
     * 提交备案申请，等待农业农村部审核通过
     * 审核通过后获得产品备案号
   
   - 申请追溯码段：
     * 在农药追溯平台申请产品追溯码段
     * 码段申请需要提供：
       - 产品登记证号（PD号）
       - 预计生产数量（如：100万瓶）
       - 生产计划（生产批次、生产日期范围）
       - 企业统一社会信用代码
     * 监管平台审核通过后，分配唯一的码段号段
       - 码段格式：通常为32位字符，包含企业标识、产品标识、流水号等
       - 示例码段范围：从 ABC1234567890123456789012345678 到 ABC1234567890123456789012349999
     * 企业获得码段后，必须严格按照码段范围生成追溯码，不得超出范围
     * 码段使用情况需要定期向监管平台上报
   
   - 备案信息获取：
     * 产品登记证号（PD号）：用于产品标识和追溯查询
     * 追溯入口地址（URL）：由监管平台统一提供
       - 标准格式：http://www.chinapesticide.org.cn/zwb/dataCenter?hash=reg-info
       - 该地址是消费者扫描二维码后的统一查询入口
     * 码段分配信息：
       - 起始码：码段的第一个码
       - 结束码：码段的最后一个码
       - 码段规则：码的生成规则和格式要求
       - 码段有效期：码段的使用期限

3. 根据国标要求制定合规码规则（32位农药单元识别码 + URL入口地址）
   - **参考法规**：
     * 《农药管理条例》（国务院令）
     * 《农药标签和说明书管理办法》（农业农村部）
     * 农业农村部关于农药标签二维码生成格式的要求
   
   - 32位农药单元识别码构成规则（按照农业农村部规定）：
     * **码的组成**（至少32位阿拉伯数字）：
       - **第1位**：农药登记类别代码
         * "1"：PD（农药正式登记）
         * "2"：WP（农药临时登记）
         * 其他类别代码按监管平台规定
       - **第2-7位**：农药登记证号后六位
         * 如果登记证号不足六位，可在www.chinapesticide.org.cn查询
         * 例如：PD20240001 → 后六位为"202401"
       - **第8位**：生产类型代码
         * "1"：登记证持有人生产
         * "2"：委托加工
         * "3"：委托分装
       - **第9-11位**：产品规格代码
         * 由企业自行编制，标识产品规格
         * 例如：001、002、003等
       - **第12-32位**：随机码（共21位）
         * 由企业自行生成或监管平台分配
         * 确保每个码的唯一性
         * 在监管平台分配的码段范围内生成
     
     * **示例格式**：12345678901234567890123456789012（32位数字）
       - 1：登记类别代码（PD）
       - 23456：登记证号后5位（假设登记证号为PD2023456）
       - 7：生产类型（登记证持有人生产）
       - 890：产品规格代码
       - 1234567890123456789012：21位随机码
     
     * **生成要求**：
       - 必须在监管平台分配的码段范围内生成
       - 必须保证唯一性（每个销售包装单元一个唯一码）
       - 码的长度至少为32位阿拉伯数字
       - 生成后需要上传到监管平台备案
       - 码与销售包装单元一一对应
   
   - URL入口地址（追溯地址）：
     * **标准追溯地址**：由农业农村部农药检定所统一提供
       - 格式：http://www.chinapesticide.org.cn/zwb/dataCenter?hash=reg-info
       - 该地址是消费者扫描二维码后的统一查询入口
     * **追溯地址的作用**：
       - 消费者扫描二维码后自动跳转到此地址
       - 系统根据32位码查询产品追溯信息
       - 显示产品基本信息、生产企业、生产批次、生产日期等
     * **追溯地址配置**：
       - 在产品表中配置（traceability_address字段）
       - 每个产品可以有不同的追溯地址（但通常使用统一地址）
       - 追溯地址变更需要重新备案
   
   - 二维码格式要求：
     * **二维码格式**：采用QR Code（二维码）或DM Code（Data Matrix码）格式
     * **二维码内容**：包含以下信息
       - 追溯URL（追溯地址）
       - 单元识别码（32位农药追溯码）
       - 农药名称
       - 登记证持有人名称
       - 如果标签上未标注，还需包含：原药登记证号和生产企业名称
   
   - 完整二维码构成：
     * **二维码内容格式**：追溯地址 + 32位农药单元识别码
     * **标准格式示例**：
       - 方式1：http://www.chinapesticide.org.cn/zwb/dataCenter?hash=reg-info&code=12345678901234567890123456789012
       - 方式2：http://www.chinapesticide.org.cn/zwb/dataCenter?hash=reg-info#12345678901234567890123456789012
     * **二维码生成**：
       - 将完整URL转换为QR Code或DM Code格式的二维码图片
       - 二维码需要满足打印要求（清晰度、尺寸等）
       - 二维码需要满足扫描要求（容错率、识别率等）
       - 二维码必须清晰、可扫描，适合印刷在标签上
   
   - 农药追溯合规性要求：
     * **国家强制标准**：
       - 《农药管理条例》（国务院令）
       - 《农药标签和说明书管理办法》（农业农村部）
       - GB/T 33993-2017《商品二维码》（国家标准）
       - 农业农村部农药追溯管理相关文件
     * **码的唯一性和关联性要求**：
       - 每个标签二维码必须唯一，对应唯一销售包装单元
       - 同一批次内不能有重复码
       - 不同批次可以使用不同码段
       - 对于有内包装和外包装的产品，内外包装二维码应关联
       - 扫描外包装二维码，应能识别内包装二维码的单元识别码信息
     * **码的可追溯性要求**：
       - 农药登记证持有人负责实施追溯要求
       - 可以自行建立或委托其他机构建立农药产品追溯系统
       - 追溯系统用于生产、标识和管理农药标签二维码
       - 码必须能追溯到：生产企业、产品登记证号、生产批次、生产日期、有效期
       - 通过追溯URL必须能查询到：产品生产日期、生产批次、质量检验等信息
       - 追溯网页显示的生产日期必须符合《农药标签和说明书管理办法》要求
       - 追溯查询网页应具有良好的兼容性，支持PC和移动设备浏览
       - 码必须关联到：生产任务、包装线、入库单、出库单
       - 追溯信息必须实时上传到监管平台
     * **码的防伪性要求**：
       - 包含校验机制，防止码被伪造或篡改
       - 码的生成规则保密，不易被破解
       - 码的使用状态可查询（已使用、未使用、已作废）
     * **数据上报要求**：
       - 生码后需要上报到监管平台
       - 生产使用后需要上报关联信息
       - 出库后需要上报销售信息
       - 定期上报码的使用情况
   
   - 系统配置准备：
     * **产品追溯地址配置**：
       - 在product表的traceability_address字段配置
       - 格式：http://www.chinapesticide.org.cn/zwb/dataCenter?hash=reg-info
     * **码段信息配置**：
       - 起始码：监管平台分配的码段起始值
       - 结束码：监管平台分配的码段结束值
       - 当前使用位置：记录已使用到哪个码
     * **码生成规则配置**（按照农业农村部规定）：
       - 第1位配置：农药登记类别代码（根据产品登记证号配置，如PD为"1"）
       - 第2-7位配置：农药登记证号后六位（从product_registration_number字段提取）
       - 第8位配置：生产类型代码（根据production_type字段配置：1-自主自产，2-委托加工，3-委托分装）
       - 第9-11位配置：产品规格代码（企业自行编制，可从specification_code字段获取）
       - 第12-32位配置：21位随机码生成规则（在监管平台分配的码段范围内生成）
     * **码生成模板准备**：
       - 准备批量生成码的模板
       - 配置生成数量、批次等信息
       - 准备码的导出格式（Excel、TXT等）

【系统配置阶段】
4. 初始化产品（创建产品基础信息）
   - 在系统中创建产品记录
   - 配置产品基本信息：产品编码、名称、规格、净含量等
   - 配置追溯地址：http://www.chinapesticide.org.cn/zwb/dataCenter?hash=reg-info
   - 配置产品登记证号（PD号）、生产许可证等
   - 关联企业、配置产品成分、包装规则等

5. 生码/导入码 → 导出产品码包清单
   - **生码（系统自动生成码）**：
     * 生码方式：系统根据配置的码段规则自动批量生成32位农药追溯码
     * 生码前提条件：
       - 产品已在系统中初始化
       - 已获得监管平台分配的码段（起始码、结束码）
       - 已配置码生成规则（前缀、流水号规则、校验位算法）
     * 生码流程：
       1. 选择产品：在系统中选择要生码的产品
       2. 设置生码参数：
          - 生码数量（如：10万瓶，生成10万个码）
          - 生码批次（如：2024-001批次）
          - 码的级别（一级码：瓶/袋码）
          - 生产类型（自主自产/委托生产）
       3. 系统自动生成码（按照农业农村部32位单元识别码规则）：
          - 第1位：根据产品登记证号自动设置登记类别代码（如PD为"1"）
          - 第2-7位：从产品登记证号中提取后六位
          - 第8位：根据生产类型设置（1-自主自产，2-委托加工，3-委托分装）
          - 第9-11位：从产品规格代码获取或企业自定义
          - 第12-32位：在监管平台分配的码段范围内生成21位随机码
          - 每个码都是至少32位阿拉伯数字的唯一标识码
          - 检查码的唯一性（防止重复）
          - 确保码段不超出监管平台分配的范围
       4. 生成码记录：
          - 在code_generation_list表中创建生码记录
          - 记录生码信息：批次、产品ID、企业ID、生码时间、生码数量等
          - 在code_traceability表中创建码记录（初始状态，未使用）
          - 码的状态：已生成、待使用
       5. 生码结果：
          - 显示生码成功数量
          - 显示码段使用情况（已使用到哪个码）
          - 记录生码日志
   
   - **导入码（从外部系统导入已生成的码）**：
     * 导入场景：
       - 码由外部系统（如监管平台、第三方系统）生成
       - 需要将已生成的码导入到本系统
       - 批量导入历史码数据
     * 导入方式：
       1. 准备码文件：
          - 格式：Excel、TXT、CSV等
          - 内容：32位码列表，每行一个码
          - 可包含附加信息：批次、产品信息等
       2. 系统导入：
          - 选择导入文件
          - 选择对应的产品
          - 设置导入参数（批次、级别等）
          - 系统验证码格式（必须至少32位阿拉伯数字）
          - 验证码结构是否符合农业农村部规定（第1位、第2-7位、第8位、第9-11位、第12-32位）
          - 系统检查码的唯一性（不能与已有码重复）
          - 系统检查码是否在分配的码段范围内
       3. 导入结果：
          - 导入成功数量
          - 导入失败数量及失败原因（格式错误、重复码、超出码段等）
          - 在code_generation_list中创建导入记录
          - 在code_traceability中创建码记录
   
   - **导出产品码包清单**：
     * 码包清单的含义：
       - 码包清单是包含所有已生成码的详细列表文件
       - 用于提供给印刷厂制作产品标签
       - 用于企业内部管理和追溯
       - 用于上报监管平台
     * 码包清单的内容：
       - 码的基本信息：
         * 32位农药追溯码（核心字段）
         * 码的序号（在批次中的顺序号）
         * 码的级别（一级/二级/三级）
         * 码的状态（已生成/已使用/已作废）
       - 产品关联信息：
         * 产品编码、产品名称
         * 产品登记证号（PD号）
         * 产品规格、净含量
         * 生产企业信息
       - 批次信息：
         * 生码批次号
         * 生码时间
         * 批文号（如有）
       - 完整二维码信息：
         * 完整URL（追溯地址 + 32位码）
         * 二维码图片（可选，用于预览）
     * 导出格式：
       - Excel格式（.xlsx）：便于查看和编辑
       - TXT格式（.txt）：纯文本，便于系统导入
       - CSV格式（.csv）：通用格式，便于数据处理
       - PDF格式（.pdf）：用于打印和存档
     * 导出流程：
       1. 选择生码记录：在code_generation_list中选择要导出的生码批次
       2. 设置导出参数：
          - 导出格式（Excel/TXT/CSV/PDF）
          - 导出字段（选择需要导出的列）
          - 导出范围（全部码/部分码）
          - 文件名（系统自动生成或自定义）
       3. 系统生成文件：
          - 从code_traceability表中查询该批次的所有码
          - 关联产品信息、企业信息
          - 生成完整URL（追溯地址 + 码）
          - 生成文件并下载
       4. 文件用途：
          - 发送给印刷厂：用于制作产品标签（标签上需要打印二维码）
          - 企业内部存档：用于追溯管理
          - 上报监管平台：用于码的备案
          - 生产使用：用于生产时扫码绑定
     * 码包清单示例（Excel格式）：
       | 序号 | 32位追溯码 | 产品名称 | 产品登记证号 | 完整URL | 状态 | 生码时间 |
       |------|-----------|---------|------------|---------|------|---------|
       | 1    | ABC123... | 杀虫剂A | PD20240001 | http://... | 待使用 | 2024-01-01 |
       | 2    | ABC123... | 杀虫剂A | PD20240001 | http://... | 待使用 | 2024-01-01 |
       | ...  | ...      | ...     | ...        | ...      | ...  | ...     |
   
   - **生码/导入码的后续流程**：
     * 码生成/导入后：
       1. 码的状态为"已生成"或"已导入"，待使用
       2. 码已关联到产品，但未关联到生产任务
       3. 码已记录在code_traceability表中，parent_code为NULL（未装箱）
     * 导出码包清单后：
       1. 码包清单发送给印刷厂
       2. 印刷厂根据清单制作产品标签（标签上包含二维码）
       3. 标签制作完成后，用于产品包装
     * 生产使用时：
       1. 生产任务创建后，扫描标签上的码
       2. 系统验证码的有效性（是否存在、是否已使用）
       3. 将码绑定到生产任务（更新code_traceability表的task_id）
       4. 码的状态更新为"已使用"

6. 导出委托印刷厂制作产品标签

7. 配置多级码关联规则（瓶/袋 → 箱 → 托）
   - 在包装规则管理中配置多级包装规则
   - 设置包装比例：如 1箱=12瓶，1托=40箱
   - 配置码的关联规则：一级码（瓶）→ 二级码（箱）→ 三级码（托）

【生产任务阶段】
8. 新建生产任务 或 同步ERP/MES任务
   - 任务创建方式：
     * 方式1：在QRS系统中手动创建生产任务
       - 选择产品、包装线、包装规则
       - 设置生产日期、包装批次、预计产量
       - 填写批准文号、原药登记证号、原药生产企业等信息
     * 方式2：从ERP/MES系统同步任务
       - ERP/MES系统创建生产订单后，通过API同步到QRS系统
       - 同步内容包括：生产单号、物料编码、批次、生产数量等
       - 同步后创建对应的生产任务记录
   - 任务信息记录：
     * 任务编码、任务名称、包装批次
     * 关联产品、包装线、包装规则
     * 生产日期、批准文号等
     * 任务状态：已创建、待审核、已审核、生产中、已完成

9. 任务审核（可选，根据客户要求配置）
   - 部分客户要求：产品创建后需要审核才能下发到生产线
   - 审核流程：
     * 审核人查看任务信息
     * 审核通过：任务状态更新为"已审核"，可以下发生产线
     * 审核不通过：任务退回，需要修改后重新提交
   - 审核记录：在task_approval_log表中记录审核信息

10. 领料/备料（从ERP系统领料）
    - **领料的重要性**：
      * 生产前必须从ERP系统领料，确保物料充足
      * 领料是生产准备的关键环节，影响生产进度
      * 领料信息需要同步到QRS系统，用于追溯管理
    - **领料流程**：
      * 在ERP系统中创建领料单：
        - 根据生产任务计算所需物料（原药、助剂、包装材料等）
        - 检查库存是否充足
        - 创建领料单，指定领料仓库、领料数量
        - 领料单审核通过后，从仓库出库
      * 领料信息同步到QRS系统：
        - 通过API接口同步领料信息（领料单号、物料编码、批次、数量等）
        - 在order_sync_log表中记录同步日志
        - 关联到生产任务（task_id）
      * 领料验证：
        - 验证领料数量是否满足生产需求
        - 验证物料批次是否符合要求
        - 记录物料信息用于后续追溯
    - **领料与生产任务的关系**：
      * 一个生产任务可以对应多个领料单（不同物料）
      * 领料单中的物料编码、批次信息用于产品追溯
      * 领料完成后，进行物料齐套检查
      * **物料齐套检查**：
        - 齐套的含义：检查生产任务所需的所有物料是否都已领料到位
        - 齐套检查内容：
          * 检查所需物料种类是否齐全（原药、助剂、包装材料等）
          * 检查每种物料的领料数量是否满足生产需求
          * 检查物料批次是否符合要求
          * 检查物料有效期是否在允许范围内
        - 齐套检查流程：
          1. 系统根据生产任务和产品配方，计算所需物料清单
          2. 查询已领料的物料信息（从order_sync_log表）
          3. 对比所需物料和已领物料：
             * 物料种类是否齐全
             * 物料数量是否充足
             * 物料批次是否匹配
          4. 齐套检查结果：
             * **齐套**：所有物料都已领料到位，数量充足
               - 生产任务状态更新为"已备料"或"已齐套"
               - 允许下发到生产线
             * **不齐套**：缺少物料或数量不足
               - 显示缺少的物料清单
               - 提示需要补充领料
               - 生产任务状态保持为"待备料"
               - 不允许下发到生产线
        - 齐套检查的作用：
          * 确保生产前物料准备充分，避免生产中断
          * 提高生产效率，减少等待时间
          * 保证产品质量，确保使用正确的物料批次
    - **领料数据记录**：
      * 在order_sync_log表中记录：
        - 生产单号（关联task表的task_code）
        - 物料编码（material_code）
        - 批次（batch）
        - 同步状态、同步时间
        - 关联任务ID（task_id）、产品ID（product_id）

11. 产前检查、备料等准备工作
    - 产前检查：
      * 检查包装线设备是否正常
      * 检查工控机、扫描器、打印机等设备状态
      * 检查标签、包装材料是否准备充足
    - 备料工作：
      * 将已领物料运送到包装线
      * 准备包装材料（瓶/袋、箱、标签等）
      * 准备二维码标签（已印刷好的标签）

12. 开工生产（工控机切换到任务生产界面）
    - 在工控机上选择生产任务
    - 工控机界面切换到该任务的生产界面
    - 显示任务信息：产品名称、批次、预计产量等
    - 准备开始生产包装

13. 扫描器识别一级码（工控机通过接口与QRS系统交互）
    - **扫描流程**：
      * 产品经过扫描工位时，PLC检测到产品信号
      * 触发扫描器扫描标签上的二维码（一级码）
      * 扫描器识别32位农药追溯码
      * **工控机通过接口将扫描信息传递给QRS系统**
    
    - **工控机与QRS系统的接口交互**：
      * **接口调用方式**：
        - 工控机通过HTTP/HTTPS接口调用QRS系统的API
        - 接口地址：QRS系统提供的RESTful API接口
        - 接口认证：通过Token或API Key进行身份验证
        - 数据格式：JSON格式传输
      
      * **接口请求内容**：
        - 扫描的32位码（code）
        - 工控机ID（ic_machine_id）
        - 包装线ID（packaging_line_id）
        - 生产任务ID（task_id）
        - 扫描时间（scan_time）
        - 扫描工位信息（workstation）
        - 其他设备信息（设备编号、设备状态等）
      
      * **QRS系统接口处理流程**：
        1. 接收工控机发送的扫描数据
        2. 验证接口权限和参数有效性
        3. 查询码信息（从code_traceability表）
        4. 验证码的有效性：
           * 码是否存在
           * 码是否已使用
           * 码是否属于当前产品
           * 码是否在有效期内
        5. 验证生产任务信息：
           * 任务是否存在
           * 任务状态是否允许绑定码
           * 任务是否属于当前包装线
        6. **重码监测**：
           * 检查duplicate_code_monitoring表，判断该码是否在其他任务中使用
           * 如果发现重码，记录到duplicate_code_monitoring表
           * 返回重码警告，需要人工处理
        7. 返回验证结果给工控机
    
    - **包装数据实时采集**（packaging_data_collection表）：
      * **采集时机**：每次扫描码时，无论成功或失败，都记录采集数据
      * **采集内容**：
        - 任务ID（task_id）
        - 包装线ID（packaging_line_id）
        - 工控机ID（ic_machine_id）
        - 码（code）
        - 码级别（code_level）
        - 父级码（parent_code，初始为NULL）
        - 采集时间（collection_time）
        - 采集数据（collection_data，JSON格式，包含完整的扫描信息）
        - 采集状态（collection_status）：成功/失败
        - 错误信息（error_info，如果采集失败）
      * **数据用途**：
        - 用于追溯包装过程的完整数据
        - 用于问题排查和数据分析
        - 用于重码监测和异常处理
    
    - **扫描结果处理**：
      * **OK（扫描成功）**：
        - QRS系统验证通过后，返回成功响应给工控机
        - QRS系统执行绑定操作：
          * 更新code_traceability表的task_id字段，绑定到生产任务
          * 更新码的状态为"已使用"
          * 记录绑定时间、工控机ID、包装线ID等信息
          * 在packaging_data_collection表中记录采集数据（状态：成功）
          * 在packaging_data_detail表中创建包装数据明细记录（初始状态）
          * 记录扫描日志
        - 工控机收到成功响应后：
          * 显示"扫描成功"提示
          * 继续生产流程（允许产品通过）
          * 记录本地日志
      
      * **NG（扫描失败）**：
        - QRS系统验证失败后，返回失败响应给工控机
        - 失败响应包含：
          * 错误码（error_code）
          * 错误信息（error_message）
          * 失败原因（如：码不存在、码已使用、码不属于当前产品、重码等）
        - QRS系统记录失败信息：
          * 在packaging_data_collection表中记录采集数据（状态：失败，记录错误信息）
        - 工控机收到失败响应后：
          * 显示"扫描失败"提示和错误信息
          * 触发报警（声光报警或屏幕提示）
          * 停止或暂停生产流程（根据配置）
          * 记录失败日志
        - 处理流程：
          * 删除/标记异常码
          * 异常手动补充扫码（人工扫描或重新贴标）
          * 重新调用接口绑定码到生产任务
          * 记录异常日志
    
    - **接口异常处理**：
      * **网络异常**：
        - 工控机检测到网络连接失败
        - 工控机本地缓存扫描数据
        - 网络恢复后，批量重传扫描数据
        - QRS系统支持批量接收和处理
        - 批量处理时，在packaging_data_collection表中批量记录采集数据
      
      * **接口超时**：
        - 设置合理的接口超时时间（如：3-5秒）
        - 超时后工控机重试（最多3次）
        - 重试失败后，记录异常并人工处理
        - 在packaging_data_collection表中记录超时异常
      
      * **接口错误**：
        - QRS系统返回错误码和错误信息
        - 工控机根据错误码进行相应处理
        - 记录错误日志用于问题排查
        - 在packaging_data_collection表中记录错误信息

【包装阶段】
11. 二级包装（瓶装箱、袋装箱）
    - **包装准备**：
      * 一级码扫描完成后，产品（瓶/袋）进入包装工位
      * 根据包装规则（packaging_rule）确定装箱数量：
        - 例如：1箱=12瓶，或1箱=20袋
        - 包装规则在任务创建时已关联（task.packaging_rule_id）
      * 准备包装箱（空箱）
      * 准备二级箱码标签（待打印或已打印）
    
    - **装箱流程**：
      * **方式1：自动装箱**（自动化包装线）
        - 产品通过传送带自动进入包装箱
        - 系统计数，达到包装规则要求的数量后自动封箱
        - 包装完成后，箱体移动到下一工位
      
      * **方式2：手动装箱**（半自动或手动包装线）
        - 操作员手动将产品装入包装箱
        - 系统提示装箱数量（如：已装8瓶，还需4瓶）
        - 达到规定数量后，操作员确认装箱完成
        - 手动封箱
    
    - **装箱验证**：
      * 系统验证装箱数量是否符合包装规则：
        - 检查装箱数量是否在包装规则的下限和上限范围内
        - 例如：包装规则要求12瓶/箱，下限10瓶，上限14瓶
        - 如果数量不在范围内，系统提示异常
      * 记录装箱信息：
        - 装箱时间
        - 装箱数量
        - 装箱操作员（如为手动装箱）
        - 包装线ID、工控机ID

12. 打印/补打、张贴二级箱码
    - **二级箱码生成**：
      * 二级码（箱码）由系统自动生成，不需要从监管平台申请
      * 码类型：`packaging`（包装码）
      * 码的格式：企业自定义格式（可以是条码、二维码等）
      * 码的生成时机：
        - 装箱完成后，系统自动生成二级码
        - 或从预生成的二级码池中分配一个码
      * 码的唯一性：确保每个箱码都是唯一的
    
    - **打印二级箱码**：
      * **自动打印**（自动化包装线）：
        - 装箱完成后，系统自动触发打印机
        - 根据包装规则中的打印模板（print_template）生成标签
        - 打印份数：根据包装规则中的print_copies字段（如：打印2份）
        - 打印机自动打印二级箱码标签
      
      * **手动打印**（半自动或手动包装线）：
        - 装箱完成后，操作员在工控机界面点击"打印箱码"
        - 系统生成二级码并发送到打印机
        - 打印机打印标签
      
      * **补打**（标签损坏或丢失）：
        - 操作员在工控机界面选择"补打箱码"
        - 输入箱码或扫描已装箱的一级码
        - 系统查询对应的二级码
        - 重新打印二级箱码标签
        - 记录补打日志
    
    - **张贴二级箱码**：
      * **自动张贴**（自动化包装线）：
        - 打印完成后，贴标机自动将标签贴到箱体指定位置
        - 贴标位置根据包装规则配置
      
      * **手动张贴**（半自动或手动包装线）：
        - 操作员从打印机取出标签
        - 手动将标签贴到箱体指定位置
        - 确保标签平整、清晰、不易脱落

13. 自动或手动采集二级码
    - **自动采集二级码**（自动化包装线）：
      * 贴标完成后，箱体经过扫描工位
      * PLC检测到箱体信号
      * 触发扫描器扫描二级箱码
      * 扫描器识别二级码
      * **工控机通过接口将二级码信息传递给QRS系统**：
        - 接口请求内容：
          * 二级码（code）
          * 工控机ID（ic_machine_id）
          * 包装线ID（packaging_line_id）
          * 生产任务ID（task_id）
          * 扫描时间（scan_time）
          * 装箱数量（packaging_quantity）
          * 装箱时间（packaging_time）
        - QRS系统接收并验证二级码
        - 返回验证结果给工控机
    
    - **手动采集二级码**（半自动或手动包装线）：
      * 操作员使用手持扫描枪扫描二级箱码
      * 或操作员在工控机界面手动输入二级码
      * 工控机将二级码信息通过接口传递给QRS系统
      * QRS系统验证并返回结果
    
    - **采集验证**：
      * QRS系统验证二级码：
        - 码是否存在（在code_traceability表中）
        - 码是否已使用
        - 码的级别是否为"二级"
        - 码是否属于当前生产任务
      * 验证通过后，准备绑定一级码和二级码

14. 绑定一级+二级码
    - **绑定流程**：
      * QRS系统接收到二级码后，查询该箱内包含的所有一级码
      * 查询方式：
        - 根据装箱时间范围，查询同一时间段内扫描的一级码
        - 或根据装箱数量，查询最近扫描的N个一级码（N=装箱数量）
        - 或根据装箱操作员确认的一级码列表
        - 从packaging_data_detail表中查询未绑定的一级码（parent_code为NULL）
      
      * 建立关联关系：
        - 更新一级码记录（code_traceability表）：
          * 将一级码的`parent_code`字段设置为二级码
          * 保持status = "已使用"
        - 更新二级码记录（code_traceability表）：
          * 将二级码的`task_id`设置为当前生产任务ID
          * 将二级码的`code_level`设置为"二级"
          * 将二级码的`code_type`设置为"packaging"
          * 将二级码的`status`设置为"已使用"
          * 记录绑定时间、工控机ID、包装线ID等信息
        - 更新包装数据明细（packaging_data_detail表）：
          * 更新一级码的parent_code为二级码
          * 更新包装状态（packaging_status）为"已装箱"
          * 记录包装时间（packaging_time）
          * 记录包装操作员（packaging_operator）
          * 记录包装数量（packaging_quantity）
        - 创建二级码的包装数据明细（packaging_data_detail表）：
          * 创建二级码的包装数据明细记录
          * 记录包装时间、包装数量、包装线ID等信息
      
      * 绑定验证：
        - 验证一级码数量是否与装箱数量一致
        - 验证一级码是否都已绑定到当前任务
        - 验证一级码是否都已使用（状态为"已使用"）
        - 验证一级码是否都已记录在packaging_data_detail表中
        - 如果验证失败，返回错误信息给工控机
    
    - **绑定结果处理**：
      * **绑定成功**：
        - QRS系统返回成功响应给工控机
        - 工控机显示"绑定成功"提示
        - 记录绑定日志
        - 在packaging_data_collection表中记录二级码采集数据（状态：成功）
        - 箱体可以继续流转到下一工位（如：装托或入库）
      
      * **绑定失败**：
        - QRS系统返回失败响应，包含失败原因：
          * 一级码数量不匹配
          * 一级码未找到
          * 一级码已绑定到其他箱
          * 其他异常情况
        - 在packaging_data_collection表中记录二级码采集数据（状态：失败，记录错误信息）
        - 工控机显示错误信息
        - 触发报警，暂停或停止包装流程
        - 需要人工处理异常情况
    
    - **数据记录**：
      * 在code_traceability表中记录：
        - 一级码：parent_code = 二级码，status = "已使用"
        - 二级码：code_level = "二级"，code_type = "packaging"，status = "已使用"
      * 在packaging_data_detail表中记录：
        - 一级码：parent_code = 二级码，packaging_status = "已装箱"
        - 二级码：创建新的包装数据明细记录
      * 在packaging_data_collection表中记录：
        - 二级码的采集数据（状态：成功/失败）
      * 记录包装数据：
        - 包装时间、包装数量
        - 包装线ID、工控机ID
        - 操作员信息（如为手动操作）
        - 绑定的一级码列表
    
    - **三级码绑定**（如需要）：
      * 如果有多级包装（箱→托），在装托时：
        - 扫描三级码（托盘码）
        - 查询托盘内包含的所有二级码（从packaging_data_detail表）
        - 更新二级码的`parent_code`为三级码（code_traceability表和packaging_data_detail表）
        - 更新三级码记录，建立关联关系
        - 创建三级码的包装数据明细记录

【入库阶段】
15. 生产任务完成，创建入库单
    - **入库单创建**：
      * 生产任务完成后，系统自动创建入库单 或 手动创建入库单
      * 关联生产任务（task_id）和仓库（warehouse_id）
      * 从packaging_data_detail表中统计已包装的数量
      * 创建入库实收明细（inbound_receipt_detail）：
        - 根据任务ID和批次，统计产量和实际入库量
        - 记录产品信息、产线、生产日期等
      * 入库单状态初始为"待审核"
    
    - **批次管理更新**：
      * 更新batch_management表：
        - 更新入库数量（inbound_quantity）
        - 更新批次状态（batch_status）
        - 如果入库完成，批次状态更新为"已入库"
    
    - **码追溯更新**：
      * 更新code_traceability表：
        - 将相关码的inbound_order_id字段设置为当前入库单ID
        - 更新码的状态
    
    - **入库审核**（可选）：
      * 如果配置了入库审核流程，需要审核后才能完成入库
      * 在inbound_approval_log表中记录审核信息
      * 审核通过后，入库单状态更新为"已审核"
    
    - **完成入库**：
      * 入库单状态更新为"已完成"
      * 更新批次管理中的入库数量
      * 记录入库日志

16. 入库数据同步到上游系统（ERP/WMS）
    - 通过入库推送接口，将入库信息同步到ERP/WMS系统
    - 在inbound_upload_log表中记录同步日志
    - 支持导入物流数据、导入XML入库、导出等功能

【出库阶段】
17. 创建出库通知单
    - **出库通知单创建**：
      * 手动创建 或 从ERP/WMS系统同步（通过出库同步接口）
      * 填写客户信息、出库时间、仓库等
      * 添加出库明细（产品、数量、批次等）
      * 在outbound_notification和outbound_notification_detail表中记录
    
    - **通知单审核**：
      * 审核通过后，状态更新为"待出库"
      * 可以生成出库单

18. 生成出库单并扫描出库码
    - **出库单创建**：
      * 从出库通知单生成出库单 或 手动创建出库单
      * 关联客户、仓库、配送区域（省份/地区）
      * 出库单状态初始为"待出库"
    
    - **扫描出库码**：
      * 使用扫描器扫描要出库的码（一级码、二级码或三级码）
      * 系统验证码的有效性：
        - 码是否存在（code_traceability表）
        - 码是否已入库
        - 码是否属于当前仓库
      * 在outbound_order_detail表中记录出库明细
      * 更新扫描数量（scanned_quantity）
      * 在outbound_log表中记录出库日志
    
    - **完成出库**：
      * 更新码追溯表（code_traceability）：
        - 将相关码的outbound_order_id字段设置为当前出库单ID
        - 更新码的状态
      * 更新批次管理（batch_management）：
        - 更新出库数量（outbound_quantity）
      * 更新出库单状态为"已完成"

19. 出库数据同步到上游系统（ERP/WMS）
    - 通过出库推送接口，将出库信息同步到ERP/WMS系统
    - 在outbound_upload_log表中记录同步日志
    - 支持导入物流数据、导入XML出库、导出等功能

【数据同步阶段】
20. 同步到开放平台认证服务
    - 将追溯数据同步到开放平台，供消费者查询

21. 自动上传平台（MES、ERP、国家监管等）
    - **生产任务集成**：从ERP/MES系统同步生产订单
    - **生产过程推送**：推送包装过程数据到ERP/MES系统
    - **入库推送**：推送入库信息到ERP/WMS系统
    - **出库推送**：推送出库信息到ERP/WMS系统
    - **出库同步**：从ERP/WMS系统同步出库数据
    - **监管系统集成**：提供API接口连接国家监管平台，实现自动数据上报和备案

22. 手动导出上传平台（如无API对接）
    - 如果上游系统没有API接口，可以手动导出数据文件
    - 支持导出Excel、XML等格式
    - 上传到上游系统

【追溯阶段】
23. 消费者追溯、市场稽查
    - **消费者扫描二维码**：
      * 消费者扫描产品标签上的二维码
      * 系统根据32位码查询code_traceability表
      * 显示完整的追溯信息（产品、生产、入库、出库等）
    
    - **串货检测**：
      * 系统记录消费者查询的IP和地区
      * 对比出库时的配送区域
      * 如果不匹配，在channel_conflict_query表中记录串货信息
    
    - **市场稽查**：
      * 监管部门可以通过系统查询产品追溯信息
      * 验证产品的合法性和真实性
```

---

## 三、功能模块详解

### 3.1 基础数据管理模块（A类）

#### 3.1.1 企业管理
- **功能**：管理生产企业的基本信息
- **数据表**：`enterprise`
- **关键字段**：企业编码、名称、地址、联系方式
- **操作**：增删改查

#### 3.1.2 产品管理
- **功能**：管理产品基础信息、生产许可证、产品登记证号
- **数据表**：`product`
- **关键字段**：
  - 产品编码、名称、规格、净含量
  - 追溯地址（用于生成二维码）
  - 产品有效期、登记证号有效期
- **关联**：关联企业、产品成分、包装规则

#### 3.1.3 产品成分管理
- **功能**：管理产品配方中的有效成分及来源
- **数据表**：`product_ingredient`
- **关键字段**：化学名称、通用名称、含量、登记证号、供应商
- **关联**：产品、供应商

#### 3.1.4 包装规则管理
- **功能**：配置多级包装规则（瓶/袋→箱→托）
- **数据表**：`packaging_rule`
- **关键字段**：
  - 规则名称、包装级、包装比例、包装数量
  - 打印份数、上下限、打印模板
- **关联**：产品

#### 3.1.5 包装线管理
- **功能**：管理多条生产线的基本信息
- **数据表**：`packaging_line`
- **关键字段**：
  - 包装线编码、名称、负责人
  - 工厂编号、车间编号
  - 关联仓库、ERP编码
- **关联**：仓库、工控机

#### 3.1.6 工控机管理
- **功能**：管理各生产线的工控设备
- **数据表**：`ic_machine`
- **关联**：包装线

#### 3.1.7 级别管理
- **功能**：管理包装级别（可合并到数据字典）
- **数据表**：`level`

#### 3.1.8 仓库管理
- **功能**：管理仓库基本信息
- **数据表**：`warehouse`
- **作用**：为产品出入库流程提供属性依赖

#### 3.1.9 客户管理
- **功能**：创建和维护客户基本信息
- **数据表**：`customer`
- **关键字段**：客户编号、名称、省市区、类型、级别
- **关联**：企业

#### 3.1.10 供应商管理
- **功能**：创建和维护供应商基本信息
- **数据表**：`supplier`
- **作用**：为产品追溯提供供应商信息基础

---

### 3.2 生产任务管理模块（A类）

#### 3.2.1 任务管理
- **功能**：统一创建（同步）任务到后台，分配到包装线，跟踪生产明细
- **优先级**：A
- **数据表**：`task`
- **关键字段**：
  - 任务编码（task_code）：唯一标识
  - 任务名称（task_name）
  - 包装线ID（packaging_line_id）
  - 包装批次（packaging_batch）
  - 产品ID（product_id）
  - 包装规则ID（packaging_rule_id）
  - 状态（status）：已创建、待审核、已审核、生产中、已完成
  - 生产日期（production_date）
  - 批准文号（approval_number）
  - 原药登记证号（original_drug_registration_number）
  - 原药生产企业（original_drug_manufacturer）
- **界面属性**：包装线、任务编码、任务名称、包装批次、产品名称、包装规则（1:5）、状态、生产日期、批准文号、报告
- **操作**：查询、新增、编辑、删除
- **完整流程**：
  1. **创建任务**：
     * 后台手动创建任务 或 从ERP/MES同步任务（通过系统集成模块）
     * 设置任务基本信息：产品、包装线、包装规则、生产日期等
     * 填写批准文号、原药登记证号、原药生产企业等信息
     * 任务状态初始为"已创建"
  2. **任务审核**（可选，根据客户要求配置）：
     * 部分客户要求审核后才能下发生产线
     * 在task_approval_log表中记录审核信息
     * 审核通过后任务状态更新为"已审核"
     * 审核不通过则退回修改
  3. **批次管理**（batch_management表）：
     * 任务创建后，系统自动或手动创建批次管理记录
     * 批次号（batch_number）：唯一标识，通常与包装批次一致
     * 关联产品ID和任务ID
     * 记录生产日期、有效期
     * 初始状态：生产数量、包装数量、入库数量、出库数量均为0
     * 批次状态（batch_status）：待生产、生产中、已完成
     * 质检状态（quality_status）：待检、已检、合格、不合格
  4. **领料/备料**（关键环节）：
     * 在ERP系统中创建领料单，领取生产所需物料
     * 领料信息通过API同步到QRS系统
     * 在order_sync_log表中记录领料同步日志
     * 记录物料编码（material_code）、批次（batch）等信息
     * 验证领料数量是否满足生产需求
     * 进行物料齐套检查
  5. **产前准备**：
     * 产前检查：设备、工控机、扫描器等
     * 备料：物料、包装材料、标签等运送到包装线
     * 检查标签是否准备充足
  6. **分配到指定包装线**：
     * 任务分配到具体的包装线
     * 工控机切换到任务生产界面
     * 任务状态更新为"生产中"
  7. **执行生产包装流程**：
     * 扫描一级码 → 绑定任务 → 包装 → 入库
     * 实时更新批次管理中的生产数量、包装数量
  8. **任务完成**：
     * 生产完成后，任务状态更新为"已完成"
     * 批次状态更新为"已完成"
     * 生成入库单

#### 3.2.2 任务审核
- **功能**：产品创建后，部分客户需要审核才能下发到生产线（可配置）
- **优先级**：A
- **数据表**：`task_approval_log`
- **关键字段**：
  - 任务ID（task_id）
  - 包装线ID（packaging_line_id）
  - 任务编码（task_code）
  - 任务名称（task_name）
  - 包装批次（packaging_batch）
  - 产品ID（product_id）
  - 包装规则ID（packaging_rule_id）
  - 状态（status）
  - 生产日期（production_date）
  - 批准文号（approval_number）
  - 审核人（approved_by）
  - 审核时间（approval_time）
- **界面属性**：包装线、任务编码、任务名称、包装批次、产品名称、包装规则、状态、生产日期、批准文号、报告
- **操作**：查询、审核
- **流程**：
  1. 创建任务后，如果配置了审核流程，任务进入"待审核"状态
  2. 审核人查看任务信息
  3. 审核通过：任务状态更新为"已审核"，可以下发生产线
  4. 审核不通过：任务退回，需要修改后重新提交
  5. 在task_approval_log表中记录审核信息

#### 3.2.3 任务特殊管理
- **功能**：管理特殊类型的生产任务
- **优先级**：B
- **数据表**：`task_special_management`
- **关键字段**：
  - 任务ID（task_id）
  - 包装线ID（packaging_line_id）
  - 任务编码（task_code）
  - 任务名称（task_name）
  - 包装批次（packaging_batch）
  - 产品ID（product_id）
  - 包装规则ID（packaging_rule_id）
  - 状态（status）
  - 特殊类型（special_type）
- **界面属性**：包装线、任务编码、任务名称、包装批次、产品名称、包装规则、状态
- **操作**：查询、编辑、删除
- **用途**：用于管理需要特殊处理的生产任务

#### 3.2.4 重码监测
- **功能**：监测多条线码冲突，显示对比，提供处理操作（如作废、替换）
- **优先级**：A
- **数据表**：`duplicate_code_monitoring`
- **关键字段**：
  - 码号（code_number）：检测到的重复码
  - 码分级（code_level）：一级/二级/三级
  - 生产任务ID（task_id）：使用该码的任务
  - 采码时间（code_collection_time）：码被采集的时间
- **界面属性**：码号、码分级、生产任务、采码时间
- **操作**：查询、处理（作废、替换等）
- **监测流程**：
  1. 工控机扫描码时，QRS系统检查该码是否已在其他任务中使用
  2. 如果发现重码，系统自动记录到duplicate_code_monitoring表
  3. 系统返回重码警告给工控机，暂停或停止生产流程
  4. 管理员在重码监测界面查看重码列表
  5. 对比不同任务中使用同一码的情况
  6. 提供处理操作：作废码、替换码、标记异常等
  7. 处理完成后，更新码的状态，允许继续生产
- **作用**：防止同一码被多个任务使用，确保码的唯一性和追溯准确性

---

### 3.3 码信息管理模块（A类）

#### 3.3.1 生码列表
- **功能**：结合追溯入口点和32位国标码生成产品码列表，支持下载后打印
- **优先级**：A
- **数据表**：`code_generation_list`
- **关键字段**：
  - 文件名（file_name）
  - 批次（batch）
  - 产品ID（product_id）
  - 批文号（document_number）
  - 企业ID（enterprise_id）
  - 生码信息（code_generation_info）：JSON格式，包含生码数量、码段范围等
  - 生码时间（code_generation_time）
  - 级别（level）：一级/二级/三级
  - 类型（type）：生码/导入
  - 状态（status）：已生成、已使用、已作废
  - 生产类型（production_type）：自主自产/委托生产
- **界面属性**：码、文件名、批次、产品名称、批文号、企业、生码信息、生码时间、级别、类型、状态、生产类型（自主自产）
- **操作**：查询、生码
- **追溯地址**：`http://www.chinapesticide.org.cn/zwb/dataCenter?hash=reg-info`
- **注册证查询地址**：http://www.chinapesticide.org.cn/zwb/dataCenter?hash=reg-info
- **流程**：
  1. **生码准备**：
     * 选择产品
     * 设置生码参数：批次、数量、级别、生产类型等
     * 确认码段范围（从监管平台申请的码段）
  2. **批量生成码**：
     * 系统根据码段规则自动批量生成32位农药追溯码
     * 在code_generation_list表中创建生码记录
     * 在code_traceability表中创建码记录（初始状态，未使用）
     * 记录生码信息（数量、码段范围等）
  3. **导入外部码**（可选）：
     * 从外部系统导入已生成的码
     * 验证码格式和唯一性
     * 记录导入信息
  4. **导出码包清单**：
     * 选择生码记录
     * 设置导出格式（Excel/TXT/CSV/PDF）
     * 生成码包清单文件
     * 包含：32位码、完整URL、产品信息、批次信息等
  5. **委托印刷厂制作标签**：
     * 将码包清单发送给印刷厂
     * 印刷厂根据清单制作产品标签（包含二维码）

#### 3.3.2 农药码查询
- **功能**：根据给定的32位农药追溯码查询完整的追溯信息
- **优先级**：A
- **查询表**：`code_traceability`（主表，code_type='pesticide'）
- **界面属性**：码、码级别、父级码、状态、产品名称、任务编码、入库单、出库单、更新时间、明细
- **操作**：查询、导出、清除
- **查询内容**：详见3.7.4节

#### 3.3.3 包装数据查询
- **功能**：根据包装任务维度显示关联码
- **优先级**：A
- **数据表**：`packaging_data_query`、`packaging_data_detail`
- **界面属性**：码、码级别、父级码、状态、更新时间
- **操作**：查询（基于农药码、包装任务）
- **查询内容**：详见3.7.5节

#### 3.3.4 码操作日志
- **功能**：查询码的分配、替换、取消等信息，包括时间和产品追溯
- **优先级**：A
- **数据表**：`code_operation_log`
- **关键字段**：
  - 包装车间（packaging_workshop）
  - 生产批次（production_batch）
  - 产品ID（product_id）
  - 批准文号（approval_number）
  - 制剂规格（formulation_specification）
  - 原始码（original_code）
  - 替换码（replacement_code）
  - 取消码（cancellation_code）
  - 操作时间（operation_time）
- **界面属性**：包装车间、生产批次、产品名称、批准文号、制剂规格、原始码、替换码、取消码、操作时间
- **操作**：查询（基于相关维度码、产品名称、生产批次、操作类型、包装车间、自定义时间范围）
- **用途**：
  - 记录码的分配、替换、取消等操作
  - 用于追溯码的使用历史
  - 用于问题排查和审计

#### 3.3.5 码追溯表（核心表）
- **功能**：记录每个码的完整追溯信息
- **数据表**：`code_traceability`
- **关键字段**：
  - 码（code）：唯一标识，32位农药追溯码或包装码
  - 码级别（code_level）：一级/二级/三级
  - 父级码（parent_code）：建立多级码关联
  - 状态（status）：已生成、已使用、已作废
  - 产品ID（product_id）
  - 任务ID（task_id）
  - 入库单ID（inbound_order_id）
  - 出库单ID（outbound_order_id）
  - 更新时间（update_time）
  - 明细（details）：JSON格式
  - 码类型（code_type）：pesticide（农药码）/packaging（包装码）
  - 生码列表ID（code_gen_id）：关联code_generation_list表
- **作用**：实现多级码关联（一级码→二级码→三级码），记录码的完整流转路径

---

### 3.4 入库管理模块（A类）

#### 3.4.1 入库实收查询
- **功能**：根据生产任务+批次查询实际入库数量，对应产线和日期
- **优先级**：A
- **数据表**：`inbound_receipt_detail`
- **关键字段**：
  - 入库单ID（inbound_order_id）
  - 批次（batch）
  - 任务ID（task_id）
  - 产品ID（product_id）
  - 产品登记证号（product_registration_number）
  - 规格（specification）
  - 产线（production_line）
  - 生产日期（production_date）
  - 产量（output_quantity）
  - 实际入库量（actual_inbound_quantity）
- **界面属性**：批次、任务编号、产品名称、产品登记证号、规格、产线、生产日期、产量、实际入库量
- **操作**：查询、导出到Excel
- **查询维度**：生产任务、批次、产品、产线、日期范围

#### 3.4.2 入库审核
- **功能**：入库单审核流程
- **优先级**：B
- **数据表**：`inbound_approval_log`
- **关键字段**：
  - 入库单ID（inbound_order_id）
  - 审核人（approved_by）
  - 审核时间（approval_time）
  - 状态（status）：待审核、已通过、已拒绝
  - 备注（remarks）
- **流程**：
  1. 入库单创建后，进入"待审核"状态
  2. 审核人查看入库单信息
  3. 审核通过：入库单状态更新为"已通过"，更新批次管理中的入库数量
  4. 审核不通过：入库单退回，需要修改后重新提交
  5. 在inbound_approval_log表中记录审核信息

#### 3.4.3 入库管理
- **功能**：管理入库单的创建、查询和管理
- **优先级**：B
- **数据表**：`inbound_order`
- **关键字段**：
  - 入库单号（inbound_order_number）：唯一标识
  - 任务ID（task_id）：关联生产任务
  - 仓库ID（warehouse_id）：关联仓库
  - 状态（status）：待审核、已审核、已完成
  - 操作员（operator）
  - 备注（remarks）
- **流程**：
  1. **创建入库单**：
     * 生产任务完成后，系统自动创建入库单 或 手动创建入库单
     * 关联生产任务（task_id）和仓库（warehouse_id）
     * 从packaging_data_detail表中统计已包装的数量
     * 创建入库实收明细（inbound_receipt_detail）：
       - 根据任务ID和批次，统计产量和实际入库量
       - 记录产品信息、产线、生产日期等
     * 入库单状态初始为"待审核"
  2. **入库审核**（可选）：
     * 如果配置了入库审核流程，需要审核后才能完成入库
     * 审核通过后，入库单状态更新为"已审核"
  3. **完成入库**：
     * 更新码追溯表（code_traceability）：
       - 将相关码的inbound_order_id字段设置为当前入库单ID
       - 更新码的状态
     * 更新批次管理（batch_management）：
       - 更新入库数量（inbound_quantity）
       * 更新批次状态
     * 入库单状态更新为"已完成"
  4. **同步到上游系统**：
     * 通过入库推送接口，将入库信息同步到ERP/WMS系统
     * 在inbound_upload_log表中记录同步日志

#### 3.4.4 入库上传日志
- **功能**：同步入库结果到上游系统（ERP/WMS）
- **优先级**：B
- **数据表**：`inbound_upload_log`
- **关键字段**：
  - 入库单ID（inbound_order_id）
  - 文件名（file_name）
  - 上传时间（upload_time）
  - 操作员（operator）
  - 状态（status）：成功/失败
  - 备注（remarks）
- **流程**：
  1. 入库单完成后，系统自动或手动触发同步
  2. 生成入库数据文件（XML/Excel格式）
  3. 调用ERP/WMS系统的入库推送接口
  4. 记录同步结果到inbound_upload_log表
  5. 如果同步失败，记录错误信息，支持重试

---

### 3.5 出库管理模块（A类）

#### 3.5.1 出库通知单
- **功能**：创建或同步出库订单，与上游系统对接
- **优先级**：A
- **数据表**：`outbound_notification`、`outbound_notification_detail`
- **关键字段**：
  - 出库通知单号（notification_number）：唯一标识
  - 企业ID（enterprise_id）
  - 客户ID（customer_id）
  - 客户编号（customer_code）
  - 客户名称（customer_name）
  - 出库时间（outbound_time）
  - 仓库ID（warehouse_id）
  - 状态（status）：待出库、已出库、已取消
  - 明细（details）：JSON格式，包含产品明细
- **明细表字段**（outbound_notification_detail）：
  - 通知单ID（notification_id）
  - 产品ID（product_id）
  - 数量（quantity）
  - 批次（batch）
  - 规格（specification）
  - 单位（unit）
- **界面属性**：ID、出库通知单号、企业编码、客户编号、客户名称、状态、出库时间、仓库、明细
- **操作**：查询（按出库通知单号、状态、仓库）、创建、同步
- **流程**：
  1. 创建出库通知单：
     * 手动创建 或 从ERP/WMS系统同步
     * 填写客户信息、出库时间、仓库等
     * 添加出库明细（产品、数量、批次等）
  2. 通知单审核：
     * 审核通过后，状态更新为"待出库"
     * 可以生成出库单

#### 3.5.2 出库管理
- **功能**：根据出库订单记录出库明细，包括配送区域和扫描记录
- **优先级**：A
- **数据表**：`outbound_order`、`outbound_order_detail`
- **关键字段**：
  - 出库单号（outbound_order_number）：唯一标识
  - 出库类型（outbound_type）
  - 客户ID（customer_id）
  - 省份/地区（province_region）：配送区域
  - 扫描数量（scanned_quantity）
  - 操作员（operator）
  - 出库时间（outbound_time）
  - 仓库ID（warehouse_id）
  - 状态（status）：待出库、出库中、已完成
- **明细表字段**（outbound_order_detail）：
  - 出库单ID（outbound_order_id）
  - 码（code）：出库的码
  - 码级别（code_level）
  - 产品ID（product_id）
  - 数量（quantity）
  - 批次（batch）
  - 生产日期（production_date）
  - 有效期（expiry_date）
- **界面属性**：ID、出库单号、出库类型、客户名称、省/市/区、扫描数量、操作员、出库时间、操作（导出全部、删除）、明细（出库明细）
- **操作**：查询、导入物流数据、导入XML出库、导出选中、导出全部
- **流程**：
  1. **创建出库单**：
     * 从出库通知单生成出库单 或 手动创建出库单
     * 关联客户、仓库、配送区域（省份/地区）
     * 出库单状态初始为"待出库"
  2. **扫描出库码**：
     * 使用扫描器扫描要出库的码（一级码、二级码或三级码）
     * 系统验证码的有效性：
       - 码是否存在（code_traceability表）
       - 码是否已入库
       - 码是否属于当前仓库
     * 在outbound_order_detail表中记录出库明细
     * 更新扫描数量（scanned_quantity）
  3. **完成出库**：
     * 更新码追溯表（code_traceability）：
       - 将相关码的outbound_order_id字段设置为当前出库单ID
       - 更新码的状态
     * 更新批次管理（batch_management）：
       - 更新出库数量（outbound_quantity）
     * 更新出库单状态为"已完成"
     * 在outbound_log表中记录出库日志
  4. **同步到上游系统**：
     * 通过出库推送接口，将出库信息同步到ERP/WMS系统
     * 在outbound_upload_log表中记录同步日志

#### 3.5.3 出库同步日志
- **功能**：同步上游系统（ERP/WMS）的出库数据记录
- **优先级**：A
- **数据表**：`outbound_sync_log`
- **关键字段**：
  - 出库单ID（outbound_order_id）
  - 出库单号（outbound_order_number）
  - 同步状态（sync_status）：成功/失败
  - 同步次数（sync_count）
  - 结果（result）：同步结果详情
  - 同步时间（sync_time）
  - 操作（operation）
- **界面属性**：日志ID、出库单ID、出库单号、同步状态、同步次数、结果、同步时间、操作
- **操作**：查询（按订单号、状态、同步时间范围）
- **流程**：
  1. ERP/WMS系统创建出库订单后，通过API同步到QRS系统
  2. QRS系统接收出库数据，创建出库通知单或出库单
  3. 记录同步结果到outbound_sync_log表
  4. 如果同步失败，记录错误信息，支持重试

#### 3.5.4 上传出库单
- **功能**：根据出库订单同步出库结果到上游系统（ERP/WMS）
- **优先级**：B
- **数据表**：`outbound_upload_log`
- **关键字段**：
  - 出库单ID（outbound_order_id）
  - 出库单号（outbound_order_number）
  - 客户名称（customer_name）
  - 出货日期（shipment_date）
  - 同步状态（sync_status）：成功/失败
  - 错误次数（error_count）
  - 结果（result）
  - 上传时间（upload_time）
  - 操作（operation）
- **界面属性**：ID、出库单号、客户名称、出货日期、同步状态、错误次数、结果、上传时间、操作
- **操作**：查询（按出库单号、状态、上传时间）
- **流程**：
  1. 出库单完成后，系统自动或手动触发同步
  2. 生成出库数据文件（XML/Excel格式）
  3. 调用ERP/WMS系统的出库推送接口
  4. 记录同步结果到outbound_upload_log表
  5. 如果同步失败，记录错误信息，支持重试

#### 3.5.5 出库日志
- **功能**：记录当前系统的出库操作
- **优先级**：A
- **数据表**：`outbound_log`
- **关键字段**：
  - 出库单ID（outbound_order_id）
  - 操作动作（action）：创建、扫描、完成、取消等
  - 操作员（operator）
  - 日志时间（log_time）
  - 备注（remarks）
- **用途**：记录出库操作的完整日志，用于追溯和审计

---

### 3.6 串货管理模块（A类）

#### 3.6.1 串货查询列表
- **功能**：显示异常串货，通过对比扫描IP记录与系统出库配送区域
- **数据表**：`channel_conflict_query`
- **关键字段**：
  - 码、产品ID、批次、客户ID
  - 出库地区、查询地区、查询时间
  - 状态、明细
- **逻辑**：
  1. 消费者扫描码查询
  2. 系统记录查询IP和地区
  3. 对比出库时的配送区域
  4. 如不匹配，标记为串货

#### 3.6.2 串货处理
- **功能**：跟进处理异常串货
- **数据表**：`channel_conflict_handling`
- **关键字段**：
  - 码、码级别、父级码、状态
  - 关联：产品、任务、入库单、出库单
  - 隐形码、操作、处理人、处理时间
- **操作**：作废、替换、标记等

---

### 3.7 统计与查询模块（A类）

#### 3.7.1 生产数据统计
- **功能**：以图表形式提供每日生产统计数据
- **优先级**：B
- **数据表**：`production_statistics`
- **关键字段**：
  - 工位（workstation）
  - 级别（level）：一级/二级/三级
  - 生产批次号（production_batch_number）
  - 产品ID（product_id）
  - 产品登记证号（product_registration_number）
  - 产量（output_quantity）
  - 统计日期（statistic_date）
- **界面属性**：工位、级别、生产批次号、产品名称、产品登记证号、产量
- **操作**：查询（按自定义时间范围）
- **用途**：
  - 统计每日生产产量
  - 按工位、级别、产品等维度统计
  - 以图表形式展示生产趋势

#### 3.7.2 订单同步日志
- **功能**：记录生产任务与ERP/MES系统的同步日志，包括任务同步和领料同步
- **数据表**：`order_sync_log`
- **关键字段**：
  - 生产单号（production_order_number）：ERP/MES系统的生产订单号
  - 物料编码（material_code）：领料单中的物料编码（原药、助剂等）
  - 批次（batch）：物料批次或生产批次
  - 同步状态（sync_status）：同步成功/失败
  - 同步次数（sync_count）：同步尝试次数
  - 结果（result）：同步结果详情
  - 同步时间（sync_time）：同步时间
  - 任务ID（task_id）：关联的生产任务
  - 产品ID（product_id）：关联的产品
- **同步内容**：
  - **任务同步**：从ERP/MES同步生产订单，创建生产任务
  - **领料同步**：从ERP同步领料单信息，记录物料编码、批次等（关键环节）
    * 领料单创建后，通过API同步到QRS系统
    * 记录领料的物料编码、批次、数量等信息
    * 用于追溯管理：产品可以追溯到使用的原药批次
  - **数据同步**：生产完成后，同步生产数据回ERP/MES系统

#### 3.7.3 包装数据导出
- **功能**：手动下载与生产任务关联的包装数据
- **优先级**：A
- **数据表**：`packaging_data_export_log`
- **关键字段**：
  - 任务ID（task_id）
  - 产品信息（product_info）：JSON格式
  - 导出信息（export_info）：JSON格式，包含导出字段、格式等
  - 操作人（operator）
  - 操作时间（operation_time）
- **界面属性**：ID、任务编码、产品信息、导出信息、操作人、操作时间
- **操作**：查询、导出包装、下载选中、下载全部
- **流程**：
  1. 选择生产任务
  2. 设置导出参数：
     * 导出格式（Excel/CSV/TXT）
     * 导出字段（码、产品信息、包装信息等）
     * 导出范围（全部/部分）
  3. 系统生成导出文件
  4. 记录导出日志到packaging_data_export_log表
  5. 支持下载和打印

#### 3.7.4 农药码查询
- **功能**：根据给定的32位农药追溯码查询完整的追溯信息
- **优先级**：A
- **查询入口**：消费者扫描二维码后，系统根据32位码查询
- **查询表**：`code_traceability`（主表，code_type='pesticide'）
- **界面属性**：码、码级别、父级码、状态、产品名称、任务编码、入库单、出库单、更新时间、明细
- **操作**：查询、导出、清除
- **查询内容**：
  - **产品信息**（product）：
    * 产品名称、产品登记证号（PD号）
    * 有效成分、剂型、规格
    * 生产企业信息
    * 产品有效期
  - **生产信息**（task）：
    * 生产任务编号、生产批次
    * 生产日期、生产车间、包装线
    * 批准文号、原药登记证号
  - **入库信息**（inbound_order）：
    * 入库单号、入库日期
    * 入库数量、仓库信息
  - **出库信息**（outbound_order）：
    * 出库单号、出库日期
    * 客户信息、配送区域
  - **多级码关联**：
    * 父级码（箱码、托盘码）
    * 同级码（同一箱内的其他瓶码）
- **追溯查询地址**：http://www.chinapesticide.org.cn/zwb/dataCenter?hash=reg-info

#### 3.7.5 包装数据查询
- **功能**：根据包装任务维度显示关联码
- **优先级**：A
- **数据表**：`packaging_data_query`
- **关键字段**：
  - 查询编码（query_code）
  - 任务ID（task_id）
  - 产品ID（product_id）
  - 包装批次（packaging_batch）
  - 包装线ID（packaging_line_id）
  - 查询类型（query_type）
  - 查询条件（query_condition）：JSON格式
  - 查询结果（query_result）：JSON格式
  - 查询数量（query_count）
  - 操作人（operator）
  - 查询时间（query_time）
- **界面属性**：码、码级别、父级码、状态、更新时间
- **操作**：查询（基于农药码、包装任务）
- **查询维度**：
  - 任务 → 码追溯表（code_traceability）
  - 任务 → 包装数据明细表（packaging_data_detail）
  - 任务 → 包装数据采集表（packaging_data_collection）
- **流程**：
  1. 选择查询维度（任务、产品、批次等）
  2. 设置查询条件
  3. 系统查询相关码信息
  4. 显示查询结果（码列表、关联信息等）
  5. 记录查询日志到packaging_data_query表

---

### 3.8 标签管理模块（A类）

#### 3.8.1 标签模板
- **功能**：管理标签模板的保存和维护（MOM系统开发的复用功能）
- **优先级**：A
- **数据表**：`label_template`
- **关键字段**：
  - 模板编码（template_code）：唯一标识
  - 模板名称（template_name）
  - 模板预览图（template_preview_image）：图片URL或Base64
  - 模板内容（template_content）：模板设计内容（JSON或XML格式）
  - 模板描述（template_description）
  - 是否启用（is_enabled）：1-启用，0-禁用
  - 产品ID（product_id）：关联产品
- **界面属性**：模板编码、模板名称、模板预览图、模板内容、模板描述、是否启用
- **操作**：查询、新增、编辑、删除、启用/禁用
- **用途**：
  - 保存标签打印模板
  - 关联到产品，用于包装线打印标签
  - 支持模板预览和编辑

#### 3.8.2 标签设计
- **功能**：标签模板设计器，集成第三方插件（暂定Lodop）
- **优先级**：A
- **作用**：设计打印模板，用于包装线打印标签
- **功能**：
  - 可视化设计标签模板
  - 支持文本、条码、二维码等元素
  - 支持变量绑定（产品信息、码信息等）
  - 支持打印预览
  - 集成Lodop打印插件
- **流程**：
  1. 打开标签设计器
  2. 选择或创建标签模板
  3. 设计标签布局（拖拽元素）
  4. 绑定数据变量
  5. 预览标签效果
  6. 保存模板到label_template表
  7. 关联到产品和包装规则

#### 3.8.3 标签打印记录
- **功能**：记录标签打印的完整日志
- **数据表**：`label_print_log`
- **关键字段**：
  - 任务ID（task_id）
  - 标签模板ID（label_template_id）
  - 码（code）：打印的码
  - 打印类型（print_type）：一级码/二级码/三级码
  - 打印数量（print_quantity）
  - 打印状态（print_status）：成功/失败
  - 打印机名称（printer_name）
  - 操作员（operator）
  - 打印时间（print_time）
  - 打印内容（print_content）：JSON格式
  - 错误信息（error_message）
- **用途**：
  - 记录每次标签打印的详细信息
  - 用于问题排查和审计
  - 统计打印数量和成功率

---

## 四、包装数据采集与明细管理

### 4.1 包装数据实时采集（packaging_data_collection表）

#### 4.1.1 功能说明
- **功能**：实时采集包装过程中的所有码扫描数据，无论成功或失败都记录
- **数据表**：`packaging_data_collection`
- **采集时机**：
  - 工控机扫描一级码时
  - 工控机扫描二级码时
  - 工控机扫描三级码时
  - 手动输入码时

#### 4.1.2 关键字段
- 任务ID（task_id）：关联生产任务
- 包装线ID（packaging_line_id）：关联包装线
- 工控机ID（ic_machine_id）：关联工控机
- 码（code）：扫描的码
- 码级别（code_level）：一级/二级/三级
- 父级码（parent_code）：父级码（初始为NULL）
- 采集时间（collection_time）：采集时间
- 采集数据（collection_data）：JSON格式，包含完整的扫描信息
  - 扫描工位（workstation）
  - 扫描时间（scan_time）
  - 设备信息（device_info）
  - 其他扩展信息
- 采集状态（collection_status）：成功/失败
- 错误信息（error_info）：如果采集失败，记录错误信息

#### 4.1.3 数据用途
- 用于追溯包装过程的完整数据
- 用于问题排查和数据分析
- 用于重码监测和异常处理
- 用于生成包装数据明细

### 4.2 包装数据明细（packaging_data_detail表）

#### 4.2.1 功能说明
- **功能**：记录每个码的详细包装信息，包括包装状态、质检状态等
- **数据表**：`packaging_data_detail`
- **创建时机**：
  - 一级码扫描成功时，创建初始记录
  - 二级码绑定一级码时，更新一级码记录，创建二级码记录
  - 三级码绑定时，更新二级码记录，创建三级码记录

#### 4.2.2 关键字段
- 任务ID（task_id）：关联生产任务
- 码（code）：码
- 码级别（code_level）：一级/二级/三级
- 父级码（parent_code）：父级码（初始为NULL，绑定后更新）
- 包装线ID（packaging_line_id）：关联包装线
- 工位（workstation）：包装工位
- 包装时间（packaging_time）：包装时间
- 包装操作员（packaging_operator）：包装操作员
- 包装数量（packaging_quantity）：包装数量（如：1箱=12瓶）
- 包装状态（packaging_status）：待包装、已包装、已装箱、已装托
- 质检状态（quality_check）：待检、已检、合格、不合格
- 质检员（quality_checker）：质检员
- 质检时间（quality_check_time）：质检时间
- 备注（remarks）：备注信息

#### 4.2.3 数据流转
1. **一级码扫描成功**：
   - 创建packaging_data_detail记录
   - parent_code = NULL
   - packaging_status = "已包装"
   - quality_check = "待检"

2. **二级码绑定一级码**：
   - 更新一级码记录：parent_code = 二级码，packaging_status = "已装箱"
   - 创建二级码记录：code_level = "二级"，packaging_status = "已包装"

3. **三级码绑定二级码**：
   - 更新二级码记录：parent_code = 三级码，packaging_status = "已装托"
   - 创建三级码记录：code_level = "三级"，packaging_status = "已包装"

4. **质检**：
   - 更新quality_check状态
   - 记录质检员和质检时间

### 4.3 包装数据查询（packaging_data_query表）

#### 4.3.1 功能说明
- **功能**：记录包装数据查询的日志，用于审计和统计
- **数据表**：`packaging_data_query`
- **查询维度**：
  - 按任务查询
  - 按产品查询
  - 按批次查询
  - 按包装线查询
  - 按码查询

#### 4.3.2 关键字段
- 查询编码（query_code）：唯一标识
- 任务ID（task_id）
- 产品ID（product_id）
- 包装批次（packaging_batch）
- 包装线ID（packaging_line_id）
- 查询类型（query_type）
- 查询条件（query_condition）：JSON格式
- 查询结果（query_result）：JSON格式
- 查询数量（query_count）
- 操作人（operator）
- 查询时间（query_time）

---

## 五、数据流转关系

### 5.1 核心实体关系图（完整版）

```
【基础数据层】
企业 (enterprise) [1]
  ├── 客户 (customer) [N] 一对多：一个企业有多个客户
  ├── 供应商 (supplier) [N] 一对多：一个企业有多个供应商
  └── 产品 (product) [N] 一对多：一个企业有多个产品

产品 (product) [1]
  ├── 产品成分 (product_ingredient) [N] 一对多：一个产品有多个成分
  │     └── 供应商 (supplier) [1] 多对一：多个成分可以来自同一供应商
  ├── 包装规则 (packaging_rule) [N] 一对多：一个产品可以有多个包装规则
  ├── 标签模板 (label_template) [N] 一对多：一个产品可以有多个标签模板
  ├── 生码列表 (code_generation_list) [N] 一对多：一个产品可以多次生码
  ├── 码操作日志 (code_operation_log) [N] 一对多：一个产品有多个码操作记录
  ├── 码追溯 (code_traceability) [N] 一对多：一个产品有多个码
  ├── 生产统计 (production_statistics) [N] 一对多：一个产品有多次生产统计
  ├── 批次管理 (batch_management) [N] 一对多：一个产品有多个批次
  ├── 订单同步日志 (order_sync_log) [N] 一对多：一个产品有多次同步记录
  ├── 包装数据查询 (packaging_data_query) [N] 一对多：一个产品有多次查询记录
  ├── 串货查询 (channel_conflict_query) [N] 一对多：一个产品有多个串货记录
  ├── 串货处理 (channel_conflict_handling) [N] 一对多：一个产品有多个串货处理记录
  ├── 入库实收明细 (inbound_receipt_detail) [N] 一对多：一个产品有多次入库记录
  ├── 出库通知单明细 (outbound_notification_detail) [N] 一对多：一个产品有多次出库通知
  └── 出库单明细 (outbound_order_detail) [N] 一对多：一个产品有多次出库记录

仓库 (warehouse) [1]
  ├── 包装线 (packaging_line) [N] 一对多：一个仓库有多条包装线
  ├── 入库单 (inbound_order) [N] 一对多：一个仓库有多个入库单
  └── 出库单 (outbound_order) [N] 一对多：一个仓库有多个出库单

包装线 (packaging_line) [1]
  ├── 工控机 (ic_machine) [N] 一对多：一条包装线有多台工控机
  ├── 任务 (task) [N] 一对多：一条包装线有多个任务
  ├── 包装数据采集 (packaging_data_collection) [N] 一对多：一条包装线有多次数据采集
  ├── 包装数据明细 (packaging_data_detail) [N] 一对多：一条包装线有多个包装明细
  └── 包装数据查询 (packaging_data_query) [N] 一对多：一条包装线有多次查询记录

包装规则 (packaging_rule) [1]
  └── 任务 (task) [N] 一对多：一个包装规则可以用于多个任务

工控机 (ic_machine) [1]
  └── 包装数据采集 (packaging_data_collection) [N] 一对多：一台工控机有多次数据采集

标签模板 (label_template) [1]
  └── 标签打印日志 (label_print_log) [N] 一对多：一个模板有多次打印记录

【任务管理层】
任务 (task) [1]
  ├── 任务审核 (task_approval_log) [N] 一对多：一个任务可以有多次审核记录
  ├── 任务特殊管理 (task_special_management) [1] 一对一：一个任务对应一个特殊管理记录（可选）
  ├── 重码监测 (duplicate_code_monitoring) [N] 一对多：一个任务有多个重码监测记录
  ├── 批次管理 (batch_management) [N] 一对多：一个任务可以有多个批次
  ├── 码追溯 (code_traceability) [N] 一对多：一个任务有多个码
  ├── 入库单 (inbound_order) [N] 一对多：一个任务可以有多个入库单
  ├── 入库实收明细 (inbound_receipt_detail) [N] 一对多：一个任务有多个入库明细
  ├── 订单同步日志 (order_sync_log) [N] 一对多：一个任务有多次同步记录
  ├── 包装数据采集 (packaging_data_collection) [N] 一对多：一个任务有多次数据采集
  ├── 包装数据明细 (packaging_data_detail) [N] 一对多：一个任务有多个包装明细
  ├── 包装数据导出 (packaging_data_export_log) [N] 一对多：一个任务有多次导出记录
  ├── 包装数据查询 (packaging_data_query) [N] 一对多：一个任务有多次查询记录
  └── 标签打印日志 (label_print_log) [N] 一对多：一个任务有多次打印记录

【码管理层】
生码列表 (code_generation_list) [1]
  └── 码追溯 (code_traceability) [N] 一对多：一次生码生成多个码

码追溯 (code_traceability) [1]
  ├── 入库单 (inbound_order) [1] 多对一：多个码可以属于同一个入库单
  ├── 出库单 (outbound_order) [1] 多对一：多个码可以属于同一个出库单
  ├── 串货查询 (channel_conflict_query) [N] 一对多：一个码可以有多次串货查询
  └── 串货处理 (channel_conflict_handling) [N] 一对多：一个码可以有多次串货处理

【入库管理层】
入库单 (inbound_order) [1]
  ├── 入库审核 (inbound_approval_log) [N] 一对多：一个入库单可以有多次审核记录
  ├── 入库实收明细 (inbound_receipt_detail) [N] 一对多：一个入库单有多个明细
  ├── 入库上传日志 (inbound_upload_log) [N] 一对多：一个入库单有多次上传记录
  ├── 码追溯 (code_traceability) [N] 一对多：一个入库单包含多个码
  └── 串货处理 (channel_conflict_handling) [N] 一对多：一个入库单有多个串货处理记录

【出库管理层】
出库通知单 (outbound_notification) [1]
  ├── 出库通知单明细 (outbound_notification_detail) [N] 一对多：一个通知单有多个明细
  └── 出库单 (outbound_order) [N] 一对多：一个通知单可以生成多个出库单

出库单 (outbound_order) [1]
  ├── 出库单明细 (outbound_order_detail) [N] 一对多：一个出库单有多个明细
  ├── 出库日志 (outbound_log) [N] 一对多：一个出库单有多个日志记录
  ├── 出库同步日志 (outbound_sync_log) [N] 一对多：一个出库单有多次同步记录
  ├── 出库上传日志 (outbound_upload_log) [N] 一对多：一个出库单有多次上传记录
  ├── 码追溯 (code_traceability) [N] 一对多：一个出库单包含多个码
  └── 串货处理 (channel_conflict_handling) [N] 一对多：一个出库单有多个串货处理记录

客户 (customer) [1]
  ├── 串货查询 (channel_conflict_query) [N] 一对多：一个客户有多个串货查询记录
  ├── 出库通知单 (outbound_notification) [N] 一对多：一个客户有多个出库通知单
  └── 出库单 (outbound_order) [N] 一对多：一个客户有多个出库单

【独立表】
系统操作日志 (system_operation_log) [独立表，无外键关联]
```

### 5.2 关系类型说明

#### 5.2.1 一对一关系（1:1）
- **任务 ↔ 任务特殊管理**：一个任务最多对应一个特殊管理记录（可选）

#### 5.2.2 一对多关系（1:N）
- **企业 → 客户/供应商/产品**：一个企业有多个客户、供应商、产品
- **产品 → 产品成分/包装规则/标签模板/生码列表等**：一个产品有多个成分、规则、模板等
- **仓库 → 包装线/入库单/出库单**：一个仓库有多条包装线、多个出入库单
- **包装线 → 工控机/任务/包装数据**：一条包装线有多台工控机、多个任务、多次数据采集
- **任务 → 各种日志和明细表**：一个任务有多个审核记录、批次、码、入库单等
- **生码列表 → 码追溯**：一次生码生成多个码
- **入库单 → 入库明细/审核/上传日志**：一个入库单有多个明细、多次审核、多次上传
- **出库单 → 出库明细/日志/同步日志**：一个出库单有多个明细、多个日志记录
- **出库通知单 → 出库通知单明细/出库单**：一个通知单有多个明细，可以生成多个出库单
- **客户 → 出库通知单/出库单/串货查询**：一个客户有多个出库单、多个串货查询记录

#### 5.2.3 多对一关系（N:1）
- **产品成分 → 供应商**：多个成分可以来自同一供应商
- **码追溯 → 入库单/出库单**：多个码可以属于同一个入库单或出库单
- **各种明细表 → 主表**：多个明细记录属于同一个主表记录

#### 5.2.4 多对多关系（M:N）
- **无直接多对多关系**：所有多对多关系都通过中间表实现
  - 例如：产品与供应商的关系通过`product_ingredient`表实现

### 5.3 关键关系说明

#### 5.3.1 码的关联关系
- **码追溯表（code_traceability）**是核心表，关联多个表：
  - 关联产品（product_id）：码属于哪个产品
  - 关联任务（task_id）：码在哪个任务中使用
  - 关联生码列表（code_gen_id）：码来自哪次生码
  - 关联入库单（inbound_order_id）：码在哪个入库单中
  - 关联出库单（outbound_order_id）：码在哪个出库单中
  - 通过parent_code字段实现多级码关联（一级码→二级码→三级码）

#### 5.3.2 任务的数据流转
- **任务（task）**是生产流程的核心，关联：
  - 包装线：任务在哪个包装线上执行
  - 产品：任务生产哪个产品
  - 包装规则：任务使用哪个包装规则
  - 批次管理：任务产生的批次
  - 码追溯：任务使用的码
  - 入库单：任务完成后的入库
  - 各种日志表：记录任务的各种操作

#### 5.3.3 出入库的数据流转
- **入库流程**：
  - 任务完成 → 创建入库单 → 入库审核 → 入库明细 → 码追溯更新 → 批次管理更新
- **出库流程**：
  - 出库通知单 → 出库单 → 出库明细 → 码追溯更新 → 批次管理更新 → 串货检测

### 5.2 码的流转路径

```
1. 生码阶段
   产品 → 生码列表 → 码追溯表（初始状态）

2. 生产阶段
   任务 → 扫描一级码 → 绑定任务 → 码追溯表（关联任务）

3. 包装阶段
   一级码 + 二级码 → 绑定关联 → 码追溯表（更新父级码关系）

4. 入库阶段
   任务完成 → 入库单 → 码追溯表（关联入库单）

5. 出库阶段
   出库单 → 扫描码 → 码追溯表（关联出库单、客户、配送区域）

6. 追溯阶段
   消费者扫描 → 查询码追溯表 → 显示完整追溯链
```

---

## 六、关键业务规则

### 5.1 多级码关联规则

#### 5.1.1 码的级别与类型
- **一级码（瓶/袋码）**：
  - 码类型：`pesticide`（农药码）
  - 码的来源：**从监管平台申请的码段生成**
  - 码的生成：在分配的码段范围内，系统自动生成32位国标码
  - 码的用途：用于产品最小包装单元（瓶/袋），消费者扫描此码进行追溯查询
  - 码的特点：
    * 必须符合国家农药追溯标准和农业农村部规定
    * 必须上报到监管平台备案
    * 每个码都是唯一的，不可重复
    * 码的格式：至少32位阿拉伯数字，按照农业农村部规定的结构生成
      - 第1位：登记类别代码
      - 第2-7位：登记证号后六位
      - 第8位：生产类型代码
      - 第9-11位：产品规格代码
      - 第12-32位：21位随机码
  
- **二级码（箱码）**：
  - 码类型：`packaging`（包装码）
  - 码的来源：**企业自己生成，不需要从监管平台申请**
  - 码的生成：系统根据包装规则自动生成，或由包装线设备生成
  - 码的用途：用于二级包装（箱），企业内部管理和物流追溯
  - 码的特点：
    * 企业自定义格式（可以是条码、二维码等）
    * 不需要上报监管平台
    * 主要用于关联多个一级码（如：1箱=12瓶）
    * 用于企业内部包装、入库、出库管理
  
- **三级码（托盘码）**：
  - 码类型：`packaging`（包装码）
  - 码的来源：**企业自己生成，不需要从监管平台申请**
  - 码的生成：系统根据包装规则自动生成，或由包装线设备生成
  - 码的用途：用于三级包装（托盘），企业内部管理和物流追溯
  - 码的特点：
    * 企业自定义格式
    * 不需要上报监管平台
    * 主要用于关联多个二级码（如：1托=40箱）
    * 用于企业内部仓储、物流管理

#### 5.1.2 申请码段与多级码的关系

**核心关系：**
```
申请的码段（监管平台）
    ↓
一级码（pesticide类型）
    ↓ 关联
二级码（packaging类型，企业自生成）
    ↓ 关联
三级码（packaging类型，企业自生成）
```

**详细说明：**

1. **申请码段 → 一级码**：
   - 从监管平台申请的码段，**专门用于生成一级码（瓶/袋码）**
   - 码段范围：如 ABC1234567890123456789012345678 到 ABC1234567890123456789012349999
   - 在此范围内生成的所有码，都是 `code_type='pesticide'` 的一级码
   - 一级码必须上报监管平台，用于消费者追溯查询

2. **一级码 → 二级码**：
   - 二级码**不需要从监管平台申请**，由企业自己生成
   - 二级码的格式可以是企业自定义（如：箱码可以是条码、二维码等）
   - 二级码的类型是 `code_type='packaging'`
   - 二级码通过 `parent_code` 字段关联到一级码（实际上是一级码的 `parent_code` 指向二级码）
   - 二级码主要用于：
     * 包装管理：记录哪些一级码装在同一箱内
     * 入库管理：按箱入库
     * 出库管理：按箱出库
     * 物流管理：箱码扫描

3. **二级码 → 三级码**：
   - 三级码**不需要从监管平台申请**，由企业自己生成
   - 三级码的格式可以是企业自定义
   - 三级码的类型是 `code_type='packaging'`
   - 三级码通过 `parent_code` 字段关联到二级码
   - 三级码主要用于：
     * 仓储管理：按托盘存储
     * 物流管理：托盘码扫描
     * 批量管理：大批量货物的管理

#### 5.1.3 码段申请与使用规则

**需要申请的码段：**
- ✅ **一级码（瓶/袋码）**：必须从监管平台申请码段
- ❌ **二级码（箱码）**：不需要申请，企业自生成
- ❌ **三级码（托盘码）**：不需要申请，企业自生成

**码段使用规则：**
- 申请的码段**只能用于生成一级码**
- 不能将申请的码段用于生成二级码或三级码
- 一级码的数量 = 申请的码段数量（如申请10万个码段，只能生成10万个一级码）
- 二级码和三级码的数量由包装规则决定（如：10万个一级码，按1箱12瓶，需要约8334个二级码）

**关联方式**：通过 `code_traceability.parent_code` 建立层级关系

### 5.2 码生成规则（按照农业农村部规定）

#### 5.2.1 32位单元识别码结构
- **码的格式**：至少32位阿拉伯数字
- **码的结构**（按照农业农村部规定）：
  - **第1位**：农药登记类别代码（如"1"代表PD，"2"代表WP）
  - **第2-7位**：农药登记证号后六位
  - **第8位**：生产类型代码（"1"为登记证持有人生产，"2"为委托加工，"3"为委托分装）
  - **第9-11位**：产品规格代码（企业自行编制）
  - **第12-32位**：随机码（共21位，在监管平台分配的码段范围内生成）

#### 5.2.2 二维码格式要求
- **二维码格式**：QR Code（二维码）或DM Code（Data Matrix码）
- **二维码内容**：包含追溯URL、单元识别码、农药名称、登记证持有人名称等

#### 5.2.3 完整二维码生成
- **追溯地址**：http://www.chinapesticide.org.cn/zwb/dataCenter?hash=reg-info
- **组合方式**：追溯地址 + 32位单元识别码 = 完整二维码URL
- **示例**：http://www.chinapesticide.org.cn/zwb/dataCenter?hash=reg-info&code=12345678901234567890123456789012

#### 5.2.4 唯一性和关联性要求
- 每个标签二维码必须唯一，对应唯一销售包装单元
- 对于有内包装和外包装的产品，内外包装二维码应关联
- 扫描外包装二维码，应能识别内包装二维码的单元识别码信息

#### 5.2.5 追溯系统要求
- 农药登记证持有人负责实施追溯要求
- 可以通过追溯URL查询到产品生产日期、生产批次、质量检验等信息
- 追溯查询网页应具有良好的兼容性，支持PC和移动设备浏览

### 5.3 串货检测规则
1. 出库时记录配送区域
2. 消费者扫描时记录查询IP和地区
3. 对比配送区域与查询地区
4. 不匹配则标记为串货

### 5.4 任务状态流转
```
创建 → 审核（可选）→ 下发生产线 → 生产中 → 完成 → 入库 → 出库
```

### 5.5 数据同步规则
- **自动同步**：通过API接口自动同步到ERP/MES/监管平台
- **手动同步**：如无API对接，手动导出模板上传

---

## 七、系统集成点

### 6.1 上游系统集成
- **ERP系统**：同步生产任务、物料编码、批次信息
- **MES系统**：同步生产订单、生产数据
- **监管平台**：上传产品备案、码段申请、追溯数据

### 6.2 下游系统集成
- **WMS系统**：同步入库、出库数据
- **开放平台认证服务**：同步追溯数据供消费者查询

### 6.3 工控机集成
- **PLC信号**：检测产品到达扫描工位
- **扫描器**：识别一级码、二级码
- **打印机**：打印二级箱码标签
- **接口集成**：
  * **接口方式**：工控机通过HTTP/HTTPS接口与QRS系统交互
  * **接口功能**：
    - 扫描码验证接口：工控机扫描后调用，QRS系统验证码并绑定任务
    - 任务查询接口：工控机查询当前生产任务信息
    - 状态上报接口：工控机上报设备状态、生产进度等
    - 异常上报接口：工控机上报扫描异常、设备故障等
  * **接口安全**：
    - 接口认证：Token或API Key认证
    - 数据加密：HTTPS传输，敏感数据加密
    - 访问控制：IP白名单、接口权限控制
  * **接口数据**：
    - 扫描数据：32位码、扫描时间、工控机ID、任务ID等
    - 任务数据：任务信息、产品信息、包装规则等
    - 状态数据：设备状态、生产进度、异常信息等
  * **接口异常处理**：
    - 网络异常：本地缓存，网络恢复后批量重传
    - 接口超时：重试机制（最多3次）
    - 接口错误：错误码和错误信息返回，工控机相应处理

---

## 八、数据安全与追溯保障

### 7.1 码的唯一性保障
- 生码时检查唯一性
- 重码监测机制
- 码操作日志记录

### 7.2 数据完整性保障
- 外键约束确保关联数据完整性
- 级联更新/删除规则
- 审核流程确保数据准确性

### 7.3 追溯链完整性
- 码追溯表记录完整流转路径
- 每个环节都有日志记录
- 支持正向追溯（码→产品→任务→出入库）和反向追溯（产品→所有码）

---

## 九、系统特点总结

1. **全流程追溯**：从产品备案到消费者查询的完整追溯链
2. **多级码管理**：支持瓶/袋→箱→托的多级码关联
3. **实时监控**：重码监测、串货检测、生产统计
4. **系统集成**：与ERP/MES/WMS/监管平台无缝对接
5. **灵活配置**：包装规则、标签模板可配置
6. **数据同步**：支持自动和手动两种同步方式


*本文档基于提供的功能模块表、流程图和数据库Schema整理而成*

